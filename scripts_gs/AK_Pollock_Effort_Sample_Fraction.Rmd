---
title: "Pollock Effort"
output:
  html_document: default
---

\n JW pulled this data from AKFIN see "data/AK_Effort_Trawl/Gasper Data/Chinook_Bycatch_Data_Description (2).html"for more specific query info. 

\n General methods:
\n Observed data:
\n Jordan counted the number of unique haul_dates for each vessel-sector-trip_target_code-year-nmfsarea-month combo, so we have a summary of all observed hauls, and this is summarised into boat days by taking the . For Shoreside delivers, that is based on your sample fraction (ie still a fraction of effort still unobserved). For mothership or CPs, this should be all of them. Note that this still doesn’t identify which deliveries were made to tenders (which of course, are not observed, GS has this data from else where and can match in, only occurs after 2006). Jordan created a trip_target_code2 that is “non-P” when gear is NPT because of 1996 ambiguity, recomends we skip 1996 because there are a bunch of trips (N=327) where trip target code is missing. However, we know that if gear type is “NPT” (non-pelagic trawl), it is not a pollock target. So we will say that if trip_target_code is missing but gear is “NPT” then trip_target_code is not pollock (“Not-P”). This leaves us a trivial number of missing trip_target_code in all years but 1996. 

\n We have vessel length for observed data, but we don't have it for all effort right now (waiting for JW to get back), so shoreside boats are not grouped into length categories. 

\n All Effort Data: 
\n Shoreside/CV fish tickets for the GOA only. JW removed the CPs because they don’t always issue fish tickets. They instead track their landings via production reports.
\n Trip-level data is provided, but we have fishign start and landing dates, so by subtracting those we get an estimate of boat days. Jordan is concerned with this because landed date not necesasrily equal to when they came into port nor when they stopped fishing, likely they dont land fish the same day they stopped fishing, likely more than a day, shorter the trip the more liklihood for error.
  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(gmodels)
library(gplots)
library(readr)
col.br= colorRampPalette(c("white", "blue","purple","red")) #colors for heatmap
every_nth = function(n) {
  return(function(x) {x[c(TRUE, rep(FALSE, n - 1))]})
}

```

```{r data prep}
#observed trips 1996- 2017

observed<-readRDS(here("data","AK_Effort_Trawl","Gasper_data","Unique_trips_Observed.RDS")) %>%
  rename_all(tolower) %>% 
  mutate(month=as.numeric(format(haul_date,"%m")),
         trip_target_code2=ifelse(akr_gear_code=="NPT","Not-P",trip_target_code),
           region = case_when(reporting_area_code == "610" ~ "E.APEN", 
                            reporting_area_code == "620" ~ "W.APEN",
                            reporting_area_code %in% c("630") ~ "NW.GOA",
                            reporting_area_code %in% c("640", "640 ") ~ "NE.GOA",
                            TRUE ~ "MISSING_LOCATION_INFO")) %>% 
  group_by(year,catcher_boat_adfg,pscnq_processing_sector,trip_target_code, month,trip_target_code2,akr_gear_code,region, reporting_area_code) %>%
  summarise(haul_days=length(unique(haul_date[!is.na(haul_date)])),
            vlength=ves_cfec_length[1],
            gf_catch=sum(official_total_catch,na.rm=TRUE)) %>%
  filter(trip_target_code == "P",!reporting_area_code == "650") %>% #only 1 entry from 650 dont know if it is SSEAK or NSEAK
  ungroup() %>%
  mutate(length_category = case_when(vlength < 125 & year < 2013 ~ "Small",
                                     vlength > 124 & year < 2013 ~ "Large",
                                     vlength > 59 & year > 2012 ~ "Large",
                                     vlength < 60 & year > 2012 ~ "Small",
                                     TRUE ~ as.character(vlength)),
          season = case_when(month %in% c(1,2,3,11,12) ~ "winter",
                                month %in% c(4, 5) ~ "spring",
                                month %in% c(6,7) ~ "summer",
                                month %in% c(8,9,10) ~ "fall",
                                TRUE~"SEASON_NA"),
         year = as.numeric(year)) %>%  #add season for plotting purposes- season structure = what ole uses in 2020 paper
  group_by(year,pscnq_processing_sector,trip_target_code,season, month,region
           #,length_category, #can add this in later if fish ticket data for obs and unobs has v length?
           ) %>%
  summarise(obs_boat_days = sum(haul_days),
             obs_catch_MT=sum(gf_catch)) #THIS IS IN MT--CONVERT TO LBS OR FISH TICKET CONVERT TO MT

#all, observed and unobserved trips ***shoreside only
fish_ticket<-readRDS(here("data","AK_Effort_Trawl","Gasper_data","fishtix_snippet.RDS")) %>% 
  mutate(fishing_start_date=as.Date(ft_date_fishing_began,format="%Y%m%d"), # the dates are wonky - convert to acutal dates
         date_landed=as.Date(ft_date_landed,format="%Y%m%d"),
         region = case_when(reporting_area_code == "610" ~ "E.APEN", 
                            reporting_area_code == "620" ~ "W.APEN",
                            reporting_area_code %in% c("630") ~ "NW.GOA",
                            reporting_area_code %in% c("640", "640 ") ~ "NE.GOA",
                            TRUE ~ "MISSING_LOCATION_INFO")) %>% 
  group_by(vessel_id,adfg_number,date_landed,year,region) %>% # group by vessel-date_landed-year,reporting_area_code
  summarise(ft_observers_onboard=ft_observers_onboard[1], # this observers_onboard field seems pretty useless.
              observed=observed[1], #  this flag for whether a vessel is observed seems somewhat more useful. Maybe you'll find it helpful?
              fishing_start_date=min(fishing_start_date), # for a particular landed date there may be multiple start dates. Pick the earliest one.
              pounds=sum(pounds[earnings>0],na.rm=TRUE)) %>%  # summarise pounds of only those species for which they got paid
  data.frame %>% 
  rowwise() %>% 
  mutate(fish_days=as.vector(difftime(date_landed,fishing_start_date,units="days")), # determine number of days between start and landed. Note that if landed the same day it will be a zero. Maybe you want to add 1? [line below]
         fish_days = case_when(fishing_start_date==date_landed ~ 1,
                               TRUE ~ fish_days),
         month=as.numeric(format(date_landed,"%m")),
         year=as.numeric(format(date_landed,"%Y")),
         season = case_when(month %in% c(1,2,3,11,12) ~ "winter",
                                month %in% c(4, 5) ~ "spring",
                                month %in% c(6,7) ~ "summer",
                                month %in% c(8,9,10) ~ "fall",
                                TRUE~"SEASON_NA")) %>% # extract a month and year field
 group_by(year,season,month,region) %>% #  group by vessel-date_landed-year,reporting_area_code
  summarise(all_boat_days = sum(fish_days),
             all_catch_MT=sum(pounds*0.000453592)) %>% #convert to MT, 0.000453592 MT = 1 LB 
filter(!region == "MISSING_LOCATION_INFO")
shoreside_observed <- observed %>%
  filter(pscnq_processing_sector == "S")


#merge data and get the fraction of obs and unobserved. 

join_data_shoreside <- left_join(fish_ticket, shoreside_observed, by=c("year", "month", "region", "season")) %>%
  dplyr::mutate(obs_boat_days = as.numeric(replace_na(obs_boat_days,0)),
                all_boat_days = replace_na(all_boat_days,0),
                unobs_boat_days = all_boat_days - obs_boat_days,
                frac_obs = obs_boat_days/all_boat_days,
                frac_obs = replace_na(frac_obs, 0))  %>%
  filter(!region == "MISSING_LOCATION_INFO")
```
\n stacked bar for observed vs unobserved effort all years and months- x axis is year.month
```{r stacked bar plots new, echo=FALSE, fig.height=5, fig.width=9}
temp.year <- as.character(c(1996:2017))
temp.month <- as.character(c(01:12))
temp.region <-  as.character(c("E.APEN", "W.APEN",  "NW.GOA", "NE.GOA"))
category <-  as.character(c("unobs_boat_days", "obs_boat_days"))
year.month<- expand.grid(temp.year, temp.month,category,temp.region) %>%  #fully factorial match between all categories 
rename(category="Var3", region="Var4")
year.month$Var2<- str_pad(year.month$Var2, width= 2, pad = "0", side="left") #add a zero before month 1-9 so that I can keep months in order
year.month <- unite(year.month, "year.month", c("Var1", "Var2"), sep = ".", remove= TRUE) #join month and year in its own dataframe 

#general plot of all effort. 
join_data_shoreside %>%  
  ungroup() %>%
  select(1,3,4,9,11) %>%   
  mutate(month = str_pad(month, "left", pad=0, width = 2) ) %>%
  unite("year.month",c("year","month"), sep = ".") %>%
  gather(3:4, key = "category", value = "boat_days") %>%
  merge(year.month, all = TRUE) %>% # add in labels
  mutate(boat_days= replace_na(boat_days,0)) %>%
  filter(!boat_days<0) %>%
    ggplot() +
      geom_bar(aes(x=year.month,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
      facet_wrap(~region, scales = "free", ncol=1) +
      ggtitle("Boat Days (Shoreside Pollock)") + # no small CP's
      theme_classic() +
      theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
      scale_x_discrete(breaks = every_nth(n = 12))
 
```


\n Stacked bar plots summarized by season

```{r plot seperately by seasons }
#make specific x-axes
temp.region <-  as.character(c("E.APEN", "W.APEN",  "NW.GOA", "NE.GOA"))
category <-  as.character(c("unobs_boat_days", "obs_boat_days"))

temp<- expand.grid(temp.year, category,temp.region) %>%  #fully factorial match between all categories 
  rename(year="Var1",category="Var2", region="Var3") #%>%
  #mutate(Var2= str_pad(Var2, width= 2, pad = "0", side="left")) #%>%
#  unite("year.month", c("Var1", "Var2"), sep = ".", remove= TRUE) #join month and year in its own dataframe 
```

```{r SPRING new}
#SPRING
join_data_shoreside %>%  
  ungroup() %>%
  filter(month %in% c(4,5)) %>%
  select(1:2, 4,9,11) %>%
  gather(4:5, key = "category", value = "boat_days") %>%
  group_by(year,region,category) %>%
  summarise(boat_days=sum(boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(boat_days= replace_na(boat_days,0)) %>%
   ggplot() +
    geom_bar(aes(x=year,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_grid(~region, scales = "free") +
    ggtitle("Spring Boat Days (Shoreside Pollock)") + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
  scale_x_discrete(breaks = every_nth(n = 5))

```

```{r SUMMER new}
#SUMMER
join_data_shoreside %>%  
  ungroup() %>%
  filter(month %in% c(6,7)) %>%
  select(1:2, 4,9,11) %>%
  gather(4:5, key = "category", value = "boat_days") %>%
  group_by(year,region,category) %>%
  summarise(boat_days=sum(boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(boat_days= replace_na(boat_days,0)) %>%
   ggplot() +
    geom_bar(aes(x=year,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_grid(~region, scales = "free") +
    ggtitle("Summer Boat Days (Shoreside Pollock)") + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
  scale_x_discrete(breaks = every_nth(n = 5))
 
```

```{r FALL new}
#FALL
join_data_shoreside %>%  
  ungroup() %>%
  filter(month %in% c(8,9,10)) %>%
  select(1:2, 4,9,11) %>%
  gather(4:5, key = "category", value = "boat_days") %>%
  group_by(year,region,category) %>%
  summarise(boat_days=sum(boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(boat_days= replace_na(boat_days,0)) %>%
   ggplot() +
    geom_bar(aes(x=year,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_grid(~region, scales = "free") +
    ggtitle("Fall Boat Days (Shoreside Pollock)") + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
  scale_x_discrete(breaks = every_nth(n = 5))
```

```{r WINTER new}
 #WINTER
join_data_shoreside %>%  
 select(1:2, 4,9,11) %>%  
  filter(month %in% c(1,2,3,11,12)) %>%
  mutate(season.temp = case_when(month %in% c(11,12) ~ "winter.1",
                       month %in% c(1:3) ~ "winter.2",
                       TRUE ~ "NA")) %>%
  gather(5:6, key = "category", value = "boat_days") %>%
  group_by(year, season.temp,region,category) %>%
  summarise(boat_days=sum(boat_days)) %>%
  ungroup() %>%
  mutate(year=as.numeric(year), year.new = case_when(season.temp == "winter.2" ~ year -1,
                              TRUE ~ year)) %>%
  group_by(year.new, region, category) %>%
  summarise(boat_days=sum(boat_days)) %>%
  dplyr::rename(year=year.new) %>%
  merge(temp) %>%
  mutate(boat_days= replace_na(boat_days,0)) %>%
  ggplot() +
    geom_bar(aes(x=year,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_grid(~region, scales = "free") +
    ggtitle("Winter Boat Days ( Shoreside Pollock)") + # no small CP's
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7)) 

 
```

\n How long do trips tend to be? Short, becoming shorter through time 

```{r trip length data}
all_data_trip_length<-readRDS(here("data","AK_Effort_Trawl","Gasper_data","fishtix_snippet.RDS")) %>% 
  mutate(fishing_start_date=as.Date(ft_date_fishing_began,format="%Y%m%d"), # the dates are wonky - convert to acutal dates
         date_landed=as.Date(ft_date_landed,format="%Y%m%d"),
         region = case_when(reporting_area_code == "610" ~ "E.APEN", 
                            reporting_area_code == "620" ~ "W.APEN",
                            reporting_area_code %in% c("630") ~ "NW.GOA",
                            reporting_area_code %in% c("640", "640 ") ~ "NE.GOA",
                            TRUE ~ "MISSING_LOCATION_INFO")) %>% 
  group_by(vessel_id,adfg_number,date_landed,year,region) %>% #  group by vessel-date_landed-year,reporting_area_code
  summarise(ft_observers_onboard=ft_observers_onboard[1], # this observers_onboard field seems pretty useless.
              observed=observed[1], #  this flag for whether a vessel is observed seems somewhat more useful. Maybe you'll find it helpful?
              fishing_start_date=min(fishing_start_date), # for a particular landed date there may be multiple start dates. Pick the earliest one.
              pounds=sum(pounds[earnings>0],na.rm=TRUE)) %>%  # summarise pounds of only those species for which they got paid
  data.frame %>% 
  rowwise() %>% 
  mutate(fish_days=as.vector(difftime(date_landed,fishing_start_date,units="days")), # determine number of days between start and landed. Note that if landed the same day it will be a zero. Maybe you want to add 1? [line below]
         fish_days = case_when(fishing_start_date==date_landed ~ 1,
                               TRUE ~ fish_days),
         month=as.numeric(format(date_landed,"%m")),
         year=as.numeric(format(date_landed,"%Y")),
         season = case_when(month %in% c(1,2,3,11,12) ~ "winter",
                                month %in% c(4, 5) ~ "spring",
                                month %in% c(6,7) ~ "summer",
                                month %in% c(8,9,10) ~ "fall",
                                TRUE~"SEASON_NA")) %>%
  group_by(year, region) %>%
  summarise(mean_trip_length = mean(fish_days),
            sd_fish_days=sd(fish_days)) %>%
  filter(!region == "MISSING_LOCATION_INFO")

all_data_trip_length %>% 
  ungroup() %>%
 # mutate(month = str_pad(month, "left", pad=0, width = 2)) %>%
  #unite("year.month",c("year","month"), sep = ".") %>%
ggplot(aes(x=year,y=mean_trip_length)) +
   geom_line()+ 
   geom_point(alpha = 0.8) +
  #geom_errorbar(aes(ymin=mean_trip_length-sd_fish_days, ymax=mean_trip_length+sd_fish_days))+
   facet_wrap(~region, scales = "free", ncol=1) +
   ggtitle("Spring Boat Days (Shoreside Pollock)") + 
   theme_classic() +
   theme(axis.text.x = element_text(angle = 90#, hjust = 1,size=7
                                    ))  



```

Fraction of Boat Days with an observer onboard.
Black = no effort, white = no observed effort

Heatmap Key: Black = No effort 
```{r heatmap obs frac}
spread.total <- join_data_shoreside %>%
  ungroup() %>%
  select(c(1,3:5,9)) %>%
  mutate(month = str_pad(month, "left", pad=0, width = 2)) %>%
  unite("year.month",1:2, remove=FALSE, sep = ".") %>%
  group_by(year.month, region) %>%
  summarise(all_boat_days = sum(all_boat_days),
            obs_boat_days = sum(obs_boat_days)) %>%  
  merge(year.month %>% select(-c(category)) %>% group_by(year.month) %>% count(region) %>%select(-c(n)), all = TRUE) %>%
  mutate(obs_frac= obs_boat_days/all_boat_days) %>%
  filter(!obs_frac >1 ) %>% #handful of errors as JW about. 
  dplyr::select(year.month,region, obs_frac) %>%
  tidyr::spread(year.month, obs_frac) 

#set up matrix for heatmap 
#spread.total<- spread.total[1:5,] 
region<- spread.total$region
spread.total<- spread.total[,2:238]
row.names(spread.total) <- region
matrix= as.matrix(spread.total)
#matrix[matrix < 0.1] <- NA #turn 0 to NA so that it doesnt get messed up in log function

# FOR X AXIS LABELS
temp.lab = as.data.frame(temp.year) #create df with all years
temp <- as.data.frame(temp.lab[rep(1:nrow(temp.lab),1,each=12),]) #duplicate each row 12 times
temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`[duplicated(temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`)] <- " " #fill duplicates with a space
temp$label<-  temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`  #change column name and remove old column

heatmap.2(matrix, Rowv=FALSE, Colv=FALSE, 
          xlab = "Year.Month",  
          scale="none", margins=c(4,6), 
          dendrogram="none", trace="none",
          col=col.br(20), #breaks=pairs.breaks,
          na.color = "black",
          key =TRUE,
          keysize = 1.5, #labRow = year_list,
          key.title = "log scale",
          adjCol = c(0.5,1.1),
          labCol = temp$label, #tell it to use dummy variable for X axis years
          labRow = region, #use dummy variable for Y axis regions so they can be north to south 
          cexCol = 0.6,
          sepcolor = "black",
          main = "Fraction of Observed Trips", 
          density.info = ("none"),
          #( "bottom.margin", "left.margin", "top.margin", "right.margin" )
          key.par=list(mar=c(2,1, 1,0.1)))

```


```{r sample frac 2}
#If there is an observer on board- how much of the catch are they surveying? 10% unless a vessel delivers to a tender, than 0%. can I use chinooky rates to estimate how many tender deliveries occured/region/month/year and just account for those that way? Tender delivery things isnt an issue until 2006
```





```{r parce effort data,eval=FALSE, echo =FALSE,message=FALSE,warning=FALSE}
#bring in obs and unobs compiled effort data and summarize to boat days
all_effort_boat_days<- all_effort %>%
        group_by(year,season,month,region,length_category,processing_sector) %>%
        dplyr::summarise(
          all_boat_days=n() ,
          all_vessel_count = n_distinct(catcher_vessel_id),
          #retained_catch_MT=sum(retained_gf_weight), #retained catch only starts in 2009 for some reason
          all_catch_MT=sum(total_gf_basis_weight))

#summarized observed effort data
#first just summarize observed effort off of the total effort 

obs_effort_boat_days <- all_effort %>%
  filter(observers_onboard > 0) %>%
  group_by(year,season,month,region,length_category,processing_sector) %>%
  dplyr::summarise(
    obs_boat_days=n(),
    obs_vessel_count=n_distinct(catcher_vessel_id),
    #retained_catch_MT=sum(retained_gf_weight), #retained catch only starts in 2009 for some reason
    obs_catch_MT=sum(total_gf_basis_weight))

unobs_effort_boat_days <- all_effort %>%
filter(observers_onboard == 0) %>%
  group_by(year,season,month,region,length_category,processing_sector) %>%
  dplyr::summarise(
    unobs_boat_days=n(),
    unobs_vessel_count=n_distinct(catcher_vessel_id),
    #retained_catch_MT=sum(retained_gf_weight), #retained catch only starts in 2009 for some reason
    unobs_catch_MT=sum(total_gf_basis_weight))

effort <- left_join(all_effort_boat_days, obs_effort_boat_days) %>%
  left_join(unobs_effort_boat_days) %>%
 mutate(obs_boat_days= replace_na(obs_boat_days,0),
        obs_vessel_count= replace_na(obs_vessel_count,0),
        obs_catch_MT= replace_na(obs_catch_MT,0))
```

```{r OLD DATA AND NOTES, eval=FALSE}
# \n This uses data from J. Gasper at AFSC. These data are observed and unobserved effort from the AI, BS and GOA groundfish fleets. 
# 
# \n The goal here is to summarize fishery effort into boat days for observed and non-observed effort. Data were grouped by year, month, region (NMFS Stat Area), length category (Small [which is less than 125ft before 2013, greater than 60 feet after 2013] or Large) and processing sector (Catcher Processer and Shoreside). 
#  
# \n I grouped data into Target: Pollock or non-Pollock, the below data are filtered to the Pollock target only. These data are GOA only.
# 
# \n Data from 2003-2006 do not have records of observed data (in "observers_onboard" and "catch_report_type" columns), even though the observer program indicates that there should be observed effort (https://drive.google.com/file/d/1ubVMTT7dEN6GXasLwOoktARVS6HafgNB/view?usp=sharing). 
# 
# \n Data from 2006-2020 the column "observers_onboard" indicates how many observers were onboard, we use this to assign a trip to observed or unobserved effort. 

#trip target date = date of first haul, matches catch activity date 

# test <- all_effort %>% 
#   filter(is.na(landing_date)) %>%
#   group_by(year, region) %>%
# count(n())
# 
# all_effort<- readRDS(here("data","AK_Effort_Trawl","Gasper_data","Chinooky_Rates_merged.RDS")) %>%
# filter(fmp_sub_area_code == "GOA", target =="pollock") %>%
#   mutate(length_category = case_when(ves_akr_length < 125 & year < 2013 ~ "Small",
#                                      ves_akr_length > 124 & year < 2013 ~ "Large",
#                                      ves_akr_length > 59 & year > 2012 ~ "Large",
#                                      ves_akr_length < 60 & year > 2012 ~ "Small",
#                                      TRUE ~ as.character(ves_akr_length)),
#          region = case_when(reporting_area_code == "610" ~ "E.APEN", 
#                             reporting_area_code == "620" ~ "W.APEN",  
#                             reporting_area_code %in% c("630") ~ "NW.GOA", 
#                             reporting_area_code %in% c("640", "640 ") ~ "NE.GOA", 
#                             reporting_area_code == "649" & adfg_stat_area_code %in% c("466032","466033","466003") ~ "NE.GOA",
#                             reporting_area_code == "649" & adfg_stat_area_code %in% c("476006","486001","476035","476005","476007","476003",
#                                                                                       "476004","476034", "475933","476031","476008","485932") ~ "NW.GOA", #there are about 600 records from NMFS AREA 649, which is the most northern part of PWS stat area- going to divide these based on in the 630/640 line continued into PWS and assign via ADFG #'s
#                             TRUE ~ "MISSING_LOCATION_INFO"))%>% #there are 14 of these because they are in area 649 but have missing ADFG #'s, all from a few days  in 2003
#         separate(trip_target_date, into = c("year", "month", "day"), sep = "-")
# #assign half of unknowns to NE, half to NW. 

    # temp.assign <- all_effort %>%    
    #         filter(region == "MISSING_LOCATION_INFO") %>% 
    #         mutate(temp.numb = rep(1:2, times =7)) %>%
    #         mutate(region = case_when(region == "MISSING_LOCATION_INFO" & temp.numb == 1 ~ "NE.GOA",
    #                     region == "MISSING_LOCATION_INFO" & temp.numb == 2 ~ "NW.GOA",
    #                     TRUE ~ region)) %>%
    #         select(-c(temp.numb))
    # 
    # all_effort <- all_effort %>%
    #   filter(!region == "MISSING_LOCATION_INFO") %>%
    #   rbind(temp.assign) %>%
    #   mutate(season = case_when(month %in% c("01", "02", "03", "12","11") ~ "winter",
    #                             month %in% c("04", "05") ~ "spring",
    #                             month %in% c("06","07") ~ "summer",
    #                             month %in% c("08","09","10") ~ "fall",
    #                             TRUE~"SEASON_NA"))   #add season for plotting purposes- season structure = what ole uses in 2020 paper

```

```{r stacked bar plots, echo=FALSE, fig.height=5, fig.width=9, eval=FALSE}
temp.year <- as.character(c(2003:2020))
temp.month <- as.character(c(01:12))
temp.region <-  as.character(c("E.APEN", "W.APEN",  "NW.GOA", "NE.GOA", "NE.NW.GOA"))
category <-  as.character(c("unobs_boat_days", "obs_boat_days"))
year.month<- expand.grid(temp.year, temp.month,category,temp.region) %>%  #fully factorial match between all categories 
rename(category="Var3", region="Var4")
year.month$Var2<- str_pad(year.month$Var2, width= 2, pad = "0", side="left") #add a zero before month 1-9 so that I can keep months in order
year.month <- unite(year.month, "year.month", c("Var1", "Var2"), sep = ".", remove= TRUE) #join month and year in its own dataframe 

temp.lab = as.data.frame(temp.year) #create df with all years
temp <- as.data.frame(temp.lab[rep(1:nrow(temp.lab),1,each=12),]) #duplicate each row 12 times
temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`[duplicated(temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`)] <- " " #fill duplicates with a space
temp$label<-  temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`  #change column name and remove old column

#Small boats/year 
 effort %>%  
  select(1:6,10,13) %>%   
  unite("year.month",c("year","month"), sep = ".") %>%
  filter(processing_sector == "S") %>%
  ungroup() %>%
  select(-c(processing_sector,length_category)) %>%
  gather(3:4, key = "category", value = "boat_days") %>%
  merge(year.month, all = TRUE) %>% # add in labels
  mutate(boat_days= replace_na(boat_days,0)) %>%
  ggplot() +
    geom_bar(aes(x=year.month,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_wrap(~region, scales = "free", ncol=5) +
    ggtitle("Boat Days (Small Shoreside Pollock)") + # no small CP's
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
   scale_x_discrete(breaks = every_nth(n = 24))
 
```

```{r plot seperately by seasons SPRING,eval=FALSE}
#make specific x-axes
temp.region <-  as.character(c("E.APEN", "W.APEN",  "NW.GOA", "NE.GOA"))
category <-  as.character(c("unobs_boat_days", "obs_boat_days"))

temp<- expand.grid(temp.year, category,temp.region) %>%  #fully factorial match between all categories 
  rename(year="Var1",category="Var2", region="Var3") #%>%
  mutate(Var2= str_pad(Var2, width= 2, pad = "0", side="left"))%>%
  unite("year.month", c("Var1", "Var2"), sep = ".", remove= TRUE) #join month and year in its own dataframe 

 
```

```{r SPRING,eval=FALSE}
#SPRING
effort %>%  
  select(1:6,10,13) %>%   
  filter(month %in% c("04","05"), processing_sector == "S") %>%
  gather(7:8, key = "category", value = "boat_days") %>%
  group_by(year,region,category) %>%
  summarise(boat_days=sum(boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(boat_days= replace_na(boat_days,0)) %>%
  ggplot() +
    geom_bar(aes(x=year,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_grid(~region, scales = "free") +
    ggtitle("Spring Boat Days (Shoreside Pollock)") + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
    scale_x_discrete(breaks = every_nth(n = 2))
```
 
```{r SUMMER SPLIT,eval=FALSE}
#SUMMER
effort %>%  
  select(1:6,10,13) %>%   
  filter(month %in% c("06","07"), processing_sector == "S") %>%
  gather(7:8, key = "category", value = "boat_days") %>%
  group_by(year,region,category) %>%
  summarise(boat_days=sum(boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(boat_days= replace_na(boat_days,0)) %>%
  ggplot() +
    geom_bar(aes(x=year,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_grid(~region, scales = "free") +
    ggtitle("Summer Boat Days (Shoreside Pollock)") + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
    scale_x_discrete(breaks = every_nth(n = 2))
 
```

```{r FALL,eval=FALSE}
#split by seasons
#FALL
effort %>%  
  select(1:6,10,13) %>%   
  filter(month %in% c("08","09","10"), processing_sector == "S") %>%
  gather(7:8, key = "category", value = "boat_days") %>%
  group_by(year,region,category) %>%
  summarise(boat_days=sum(boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(boat_days= replace_na(boat_days,0)) %>%
  ggplot() +
    geom_bar(aes(x=year,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_grid(~region, scales = "free") +
    ggtitle("Fall Boat Days (Shoreside Pollock)") + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
    scale_x_discrete(breaks = every_nth(n = 2))
 
```

```{r WINTER,eval=FALSE}
 #WINTER
 effort %>%  
  select(1:6,10,13) %>%   
  filter(month %in% c("11","12","01","02","03"), processing_sector == "S") %>%
  mutate(season.temp = case_when(month %in% c("11","12") ~ "winter.1",
                       month %in% c("01","02", "03") ~ "winter.2",
                       TRUE ~ "NA")) %>%
  gather(7:8, key = "category", value = "boat_days") %>%
  group_by(year, season.temp,region,category) %>%
  summarise(boat_days=sum(boat_days)) %>%
  ungroup() %>%
  mutate(year=as.numeric(year), year.new = case_when(season.temp == "winter.2" ~ year -1,
                              TRUE ~ year)) %>%
  group_by(year.new, region, category) %>%
  summarise(boat_days=sum(boat_days)) %>%
  merge(temp) %>%
  mutate(boat_days= replace_na(boat_days,0)) %>%
  ggplot() +
    geom_bar(aes(x=year.new,y=boat_days, fill = category), position="stack", stat="identity",alpha = 0.8) +
    facet_grid(~region, scales = "free") +
    ggtitle("Winter Boat Days ( Shoreside Pollock)") + # no small CP's
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7)) 

 
```

```{r heatmap setup,eval=FALSE}
#do year.month combo to merge in
temp.year <- as.character(c(2006:2020))
temp.month <- as.character(c(01:12))
temp.region <-  as.character(c("E.APEN", "W.APEN",  "NW.GOA", "NE.GOA", "NE.NW.GOA"))
temp.length <-  as.character(c("Small", "Large"))
temp.processor <-  as.character(c("S","CP"))

year.month<- expand.grid(temp.year, temp.month,temp.length,temp.processor,temp.region) %>%  #fully factorial match between all categories 
rename(length_category="Var3", processing_sector="Var4", region="Var5")

year.month$Var2<- str_pad(year.month$Var2, width= 2, pad = "0", side="left") #add a zero before month 1-9 so that I can keep months in order
year.month <- unite(year.month, "year.month", c("Var1", "Var2"), sep = ".", remove= TRUE) #join month and year in its own dataframe 

#merge.total$region.use <- recode(merge.total$region, 'WAC'=1, 'COL'=2, 'NOR'=3, 'SOR'=4, 'NCA'= 5, 'MEN'=6, 'SFB' = 7, 'MONT' = 8)

#create an label for x axis with blanks so you can see years 
temp.lab = as.data.frame(temp.year) #create df with all years
temp <- as.data.frame(temp.lab[rep(1:nrow(temp.lab),1,each=12),]) #duplicate each row 12 times
temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`[duplicated(temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`)] <- " " #fill duplicates with a space
temp$label<-  temp$`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`  #change column name and remove old column
temp <- temp %>% 
  dplyr::select(-c(`temp.lab[rep(1:nrow(temp.lab), 1, each = 12), ]`))
#recode regions so they are numbered with North = 1, so north is on top. 
#temp.region <- c('WAC','COL','NOR','SOR', 'NCA', 'MEN', 'SFB', 'MONT')
```
 
```{r heatmap ALL EFFORT ALL SECTORS ETC,eval=FALSE}
spread.total <- effort %>%
  filter(!year<2006) %>%
  unite("year.month",1:2, remove=FALSE, sep = ".") %>%
  group_by(year.month, region) %>%
  summarise(total_effort = sum(all_boat_days)) %>% #,total_effort = sum(all_boat_days), )
  #filter(length_category == "Small", processing_sector == "S", year > 2005) %>%
  #mutate(fraction_observed = obs_boat_days/all_boat_days)  
 merge(year.month %>% select(-c(processing_sector, length_category)) %>% group_by(year.month) %>% count(region) %>%select(-c(n)), all = TRUE) %>%
  dplyr::select(year.month,region, total_effort) %>%
  tidyr::spread(year.month, total_effort) 

#set up matrix for heatmap 
spread.total<- spread.total[1:5,] 
region<- spread.total$region
spread.total<- spread.total[,2:181]
matrix <- data.matrix(spread.total)
row.names(matrix) <- region
#matrix[matrix < 0.1] <- NA #turn 0 to NA so that it doesnt get messed up in log function

matrix <- log(matrix) #log matrix values so that scale 

heatmap.2(matrix, Rowv=FALSE, Colv=FALSE, 
          xlab = "Year.Month",  
          scale="none", margins=c(4,6), 
          dendrogram="none", trace="none",
          col=col.br(20), #breaks=pairs.breaks,
          na.color = "black",
          key =TRUE,
          keysize = 1.5, #labRow = year_list,
          key.title = "log scale",
          adjCol = c(0.5,1.1),
          labCol = temp$label, #tell it to use dummy variable for X axis years
          labRow = temp.region, #use dummy variable for Y axis regions so they can be north to south 
          cexCol = 0.6,
          sepcolor = "black",
          main = "Total Effort\n(log boat days\nall sectors all boat lengths)", 
          density.info = ("none"),
          #( "bottom.margin", "left.margin", "top.margin", "right.margin" )
          key.par=list(mar=c(2,1, 1,0.1)))

```
 
```{r heatmap OBS AND UNOBS EFFORT SMALL SHORESIDE,eval=FALSE}
spread.total <- effort %>%
  filter(!year<2006, processing_sector == "S", length_category =="Small") %>%
  unite("year.month",1:2, remove=FALSE, sep = ".") %>%
  group_by(year.month, region) %>%
  summarise(total_effort = sum(all_boat_days)) %>% #,total_effort = sum(all_boat_days), )
  #filter(length_category == "Small", processing_sector == "S", year > 2005) %>%
  #mutate(fraction_observed = obs_boat_days/all_boat_days)  
 merge(year.month %>% select(-c(processing_sector, length_category)) %>% group_by(year.month) %>% count(region) %>%select(-c(n)), all = TRUE) %>%
  dplyr::select(year.month,region, total_effort) %>%
  tidyr::spread(year.month, total_effort) %>%
    dplyr::select(-c(region))

#set up matrix for heatmap 
#spread.total<- spread.total[1:5,] 
#region<- spread.total$region
spread.total<- spread.total[,-1]
matrix <- data.matrix(spread.total)
row.names(matrix) <- region
#matrix[matrix < 0.1] <- NA #turn 0 to NA so that it doesnt get messed up in log function

matrix <- log(matrix) #log matrix values so that scale 

heatmap.2(matrix, Rowv=FALSE, Colv=FALSE, 
           xlab = "Year.Month",  
          scale="none", margins=c(4,6), 
          dendrogram="none", trace="none",
          col=col.br(20), #breaks=pairs.breaks,
          na.color = "black",
          key =TRUE,
          keysize = 1.5, #labRow = year_list,
          key.title = "log scale",
          adjCol = c(0.5,1.1),
          labCol = temp$label, #tell it to use dummy variable for X axis years
          labRow = temp.region, #use dummy variable for Y axis regions so they can be north to south 
          cexCol = 0.6,
          sepcolor = "black",
          main = "Small Shoreside Obs and Unobs",  
          density.info = ("none"),
          #( "bottom.margin", "left.margin", "top.margin", "right.margin" )
          key.par=list(mar=c(2,1, 1,0.1)))

```

```{r heatmap OBS AND UNOBS EFFORT LARGE SHORESIDE,eval=FALSE}
spread.total <- effort %>%
  filter(!year<2006, processing_sector == "S", length_category =="Large") %>%
  unite("year.month",1:2, remove=FALSE, sep = ".") %>%
  group_by(year.month, region) %>%
  summarise(total_effort = sum(all_boat_days)) %>% #,total_effort = sum(all_boat_days), )
  #filter(length_category == "Small", processing_sector == "S", year > 2005) %>%
  #mutate(fraction_observed = obs_boat_days/all_boat_days)  
 merge(year.month %>% select(-c(processing_sector, length_category)) %>% group_by(year.month) %>% count(region) %>%select(-c(n)), all = TRUE) %>%
  dplyr::select(year.month,region, total_effort) %>%
  tidyr::spread(year.month, total_effort) %>%
    dplyr::select(-c(region))

#set up matrix for heatmap 
#spread.total<- spread.total[1:5,] 
#region<- spread.total$region
spread.total<- spread.total[,-1]
matrix <- data.matrix(spread.total)
row.names(matrix) <- region
#matrix[matrix < 0.1] <- NA #turn 0 to NA so that it doesnt get messed up in log function

matrix <- log(matrix) #log matrix values so that scale 

heatmap.2(matrix, Rowv=FALSE, Colv=FALSE, 
          xlab = "Year.Month",  
          scale="none", margins=c(4,6), 
          dendrogram="none", trace="none",
          col=col.br(20), #breaks=pairs.breaks,
          na.color = "black",
          key =TRUE,
          keysize = 1.5, #labRow = year_list,
          key.title = "log scale",
          adjCol = c(0.5,1.1),
          labCol = temp$label, #tell it to use dummy variable for X axis years
          labRow = temp.region, #use dummy variable for Y axis regions so they can be north to south 
          cexCol = 0.6,
          sepcolor = "black",
          main = "Large Shoreside Obs and Unobs", 
          density.info = ("none"),
          #( "bottom.margin", "left.margin", "top.margin", "right.margin" )
          key.par=list(mar=c(2,1, 1,0.1)))

```

```{r heatmap OBS AND UNOBS EFFORT ALL CP there are no small CPs,eval=FALSE}
spread.total <- effort %>%
  filter(!year<2006, processing_sector == "CP") %>%
  unite("year.month",1:2, remove=FALSE, sep = ".") %>%
  group_by(year.month, region) %>%
  summarise(total_effort = sum(all_boat_days)) %>% #,total_effort = sum(all_boat_days), )
  #filter(length_category == "Small", processing_sector == "S", year > 2005) %>%
  #mutate(fraction_observed = obs_boat_days/all_boat_days)  
 merge(year.month %>% select(-c(processing_sector, length_category)) %>% group_by(year.month) %>% count(region) %>%select(-c(n)), all = TRUE) %>%
  dplyr::select(year.month,region, total_effort) %>%
  tidyr::spread(year.month, total_effort) %>%
    dplyr::select(-c(region))

#set up matrix for heatmap 
#spread.total<- spread.total[1:5,] 
#region<- spread.total$region
spread.total<- spread.total[,-1]
matrix <- data.matrix(spread.total)
row.names(matrix) <- region
#matrix[matrix < 0.1] <- NA #turn 0 to NA so that it doesnt get messed up in log function

matrix <- log(matrix) #log matrix values so that scale 

heatmap.2(matrix, Rowv=FALSE, Colv=FALSE, 
         xlab = "Year.Month",  
          scale="none", margins=c(4,6), 
          dendrogram="none", trace="none",
          col=col.br(20), #breaks=pairs.breaks,
          na.color = "black",
          key =TRUE,
          keysize = 1.5, #labRow = year_list,
          key.title = "log scale",
          adjCol = c(0.5,1.1),
          labCol = temp$label, #tell it to use dummy variable for X axis years
          labRow = temp.region, #use dummy variable for Y axis regions so they can be north to south 
          cexCol = 0.6,
          sepcolor = "black",
          main = "Catcher Processor, Observed and Unobs", 
          density.info = ("none"),
          #( "bottom.margin", "left.margin", "top.margin", "right.margin" )
          key.par=list(mar=c(2,1, 1,0.1)))

```

```{r heatmap FRACTION OBSERVED all sectors all lengths,eval=FALSE}
spread.total <- effort %>%
  filter(!year<2006 #, processing_sector == "CP"
         ) %>%
  unite("year.month",1:2, remove=FALSE, sep = ".") %>%
  group_by(year.month, region) %>%
  summarise(total_effort = sum(all_boat_days),obs_boat_days = sum(obs_boat_days)) %>%
  mutate(fraction_observed = obs_boat_days/total_effort)  %>%
  merge(year.month %>% select(-c(processing_sector, length_category)) %>% group_by(year.month) %>% count(region) %>%select(-c(n)), all = TRUE) %>%
  dplyr::select(year.month,region, fraction_observed) %>%
  tidyr::spread(year.month, fraction_observed) %>%
  dplyr::select(-c(region))

#set up matrix for heatmap 
#spread.total<- spread.total[1:5,] 
#region<- spread.total$region
spread.total<- spread.total[,-1]
matrix <- data.matrix(spread.total)
row.names(matrix) <- region
#matrix[matrix < 0.1] <- NA #turn 0 to NA so that it doesnt get messed up in log function

heatmap.2(matrix, Rowv=FALSE, Colv=FALSE, 
           xlab = "Year.Month",  
          scale="none", margins=c(4,6), 
          dendrogram="none", trace="none",
          col=col.br(20), #breaks=pairs.breaks,
          na.color = "black",
          key =TRUE,
          keysize = 1.5, #labRow = year_list,
          adjCol = c(0.5,1.1),
          labCol = temp$label, #tell it to use dummy variable for X axis years
          labRow = temp.region, #use dummy variable for Y axis regions so they can be north to south 
          cexCol = 0.6,
          sepcolor = "black",
          main = "Fraction of Boat Days Observed\n (all sectors and lengths)", 
          density.info = ("none"),
          #( "bottom.margin", "left.margin", "top.margin", "right.margin" )
          key.par=list(mar=c(2,1, 1,0.1)))

```


```{r data comparison to see how we can use 2003-2006 data,eval=FALSE}
#summarize proportion of obs and un obs data based on columns: obs_onboard & catch_report_type_code 
#do they give the same info? is that info comparable to the observer table? then can use the trip type for 2003-2006 data. 

#chart from observer coverage program says that trips between 2003 and 2012 should have sel-selected coverage for a minimum 30% of fishing days by gear/quarter and at least one trip/fishery

#take month and length category to compare to expected observer rates 
effort.comp<- all_effort %>% 
  mutate(catch_type_code_temp=case_when(catch_report_type_code == "OBS" ~ "observed_catch_type_code",
                                   TRUE ~ "unobs_catch_type_code"), 
         observer_num_temp = case_when(observers_onboard > 0 ~ "observed_number",
         TRUE ~ "unobs_number")) %>%
  gather(34:35, key = "data_type", value="obs_unobs") %>%
   mutate(quarter = case_when(month %in% c("01","02","03") ~ "quarter.1",
                             month %in% c("04","05","06") ~ "quarter.2",
                             month %in% c("07","08","09") ~ "quarter.3",
                             month %in% c("10","11","12") ~ "quarter.4",
                             TRUE ~ "UNASS")) %>%
  group_by(year,quarter,processing_sector,data_type) %>%
 #change month to quarter to compare to observer chart
  count(obs_unobs) %>%
  ungroup() %>%
  dplyr::select(-c("data_type")) %>%
  spread(obs_unobs,n) %>%
  mutate(observed_catch_type_code=replace_na(observed_catch_type_code,0),
         observed_number=replace_na(observed_number,0),
         fraction.obs.catch.report = observed_catch_type_code/unobs_catch_type_code,
         fraction.obs.number=observed_number/unobs_number)

temp<-effort.comp %>%
  filter(year > 2005, year<2013, processing_sector=="S") %>%
  select(year, quarter,fraction.obs.catch.report,fraction.obs.number)
  
```
