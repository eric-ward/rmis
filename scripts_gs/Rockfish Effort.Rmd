---
title: "rockfish effort"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(gmodels)
library(gplots)
library(readr)
col.br= colorRampPalette(c("white", "blue","purple","red")) #colors for heatmap
every_nth = function(n) {
  return(function(x) {x[c(TRUE, rep(FALSE, n - 1))]})
}
```

 
\n How does RMIS classify a rockfish trip? See last figure,RMIS recoveries and effort match better when I classify Rockfish trips using the target code rather than the management code

\n Data here is 2010-2017. Jordan suggests identifying trips based on the mangement code RPP, but when I do that, effort and recoveries have a larger mismatch than when I identify rockfish trips by trip target code K. (See last two figures) 

\n If we use rockfish trip code data starts in 1996 but 1996- 2013 observer fraction in not known. If we use the management code, management code is used in the data starting in 2010. 2010-2013 the observed fraction is also unknown. For both data sets, 100% census starting in 2013. 

```{r prep data}
rockfish_observed<-readRDS(here("data","AK_Effort_Trawl","Gasper_data","Unique_trips_Observed.RDS")) %>%
  rename_all(tolower) %>% 
  mutate(month=as.numeric(format(haul_date,"%m")),
           region = case_when(reporting_area_code == "610" ~ "E.APEN", 
                            reporting_area_code == "620" ~ "W.APEN",
                            reporting_area_code %in% c("630") ~ "NW.GOA",
                            reporting_area_code %in% c("640", "640 ") ~ "NE.GOA",
                            TRUE ~ "MISSING_LOCATION_INFO")) %>% 
  group_by(year,#management_program_code,
           catcher_boat_adfg,pscnq_processing_sector,trip_target_code, month,akr_gear_code,region, reporting_area_code) %>%
  summarise(haul_days=length(unique(haul_date[!is.na(haul_date)])),
            vlength=ves_cfec_length[1],
            gf_catch=sum(official_total_catch,na.rm=TRUE)) %>%
  filter(trip_target_code=="K",!reporting_area_code == "650" #only 4 entries with 650 in mid 1990s
         ) %>% #Filter for rockfish 
  ungroup() %>%
  mutate(year = as.numeric(year)) %>%  
  group_by(year,pscnq_processing_sector,trip_target_code,month,region) %>%
  summarise(boat_days = sum(haul_days)
            # obs_catch_MT=sum(gf_catch)
            ) %>%  
 mutate(obs_boat_days=(replace(boat_days, year<2012, NA)))
```

\n Vertical line is at the start of 2013 to show when RMIS starts recording rockfish as a seperate fleet

```{r bar plots new, fig.height=5, fig.width=9}
temp.year <- as.character(c(2010:2017))
temp.month <- as.character(c(01:12))
temp.region <-  as.character(c("E.APEN", "W.APEN",  "NW.GOA", "NE.GOA"))
temp.sector <- as.character(c("CP", "S"#,"M"
                              ))
year.month<- expand.grid(temp.year, temp.month,temp.region, temp.sector) %>%  #fully factorial match between all categories 
rename(region="Var3", pscnq_processing_sector="Var4")
year.month$Var2<- str_pad(year.month$Var2, width= 2, pad = "0", side="left") #add a zero before month 1-9 so that I can keep months in order
year.month <- unite(year.month, "year.month", c("Var1", "Var2"), sep = ".", remove= TRUE) #join month and year in its own dataframe 

#general plot of all effort. 
rockfish_observed %>%  
  ungroup() %>%
  filter(!pscnq_processing_sector=="M") %>%
  select(year,month,region,pscnq_processing_sector,obs_boat_days) %>%   
  mutate(month = str_pad(month, "left", pad=0, width = 2) ) %>%
  unite("year.month",c("year","month"), sep = ".") %>%
  merge(year.month, all = TRUE) %>% # add in labels
  mutate(obs_boat_days= replace_na(obs_boat_days,0)) %>%
    ggplot() +
      geom_bar(aes(x=year.month,y=obs_boat_days), stat="identity",alpha = 0.8) +
      facet_grid(region~pscnq_processing_sector, scales = "free") +
      ggtitle("Boat Days (Rockfish)") +  
      theme_classic() +
      theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
      scale_x_discrete(breaks = every_nth(n = 12)) +
  geom_vline(aes(xintercept="2013.01"),color="magenta")
 
```

\n Now check seasonal coverage 

```{r plot seperately by seasons }
temp<- expand.grid(temp.year, temp.region,temp.sector) %>%  #fully factorial match between all categories 
  rename(year="Var1",region="Var2", pscnq_processing_sector="Var3") #%>%
  #mutate(Var2= str_pad(Var2, width= 2, pad = "0", side="left")) #%>%
#  unite("year.month", c("Var1", "Var2"), sep = ".", remove= TRUE) #join month and year in its own dataframe 
```

```{r SPRING new}
#SPRING
rockfish_observed %>%  
  ungroup() %>%
  filter(!pscnq_processing_sector=="M") %>%
  select(year,month,region,pscnq_processing_sector,obs_boat_days) %>%   
  filter(month %in% c(4,5)) %>%
  group_by(year,region,pscnq_processing_sector) %>%
  summarise(obs_boat_days=sum(obs_boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(obs_boat_days= replace_na(obs_boat_days,0)) %>%
   ggplot() +
    geom_bar(aes(x=year,y=obs_boat_days),stat="identity",alpha = 0.8) +
    facet_grid(pscnq_processing_sector~region, scales = "free") +
    ggtitle("Spring Boat Days (Rockfish)") + 
    theme_classic() +
    geom_vline(aes(xintercept="2013"),color="magenta")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
    scale_x_discrete(breaks = every_nth(n = 5))
```

```{r SUMMER new}
#SUMMER
rockfish_observed %>%  
  ungroup() %>%
  filter(!pscnq_processing_sector=="M") %>%
  select(year,month,region,pscnq_processing_sector,obs_boat_days) %>%   
  filter(month %in% c(6,7)) %>%
  group_by(year,region,pscnq_processing_sector) %>%
  summarise(obs_boat_days=sum(obs_boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(obs_boat_days= replace_na(obs_boat_days,0)) %>%
   ggplot() +
    geom_bar(aes(x=year,y=obs_boat_days),stat="identity",alpha = 0.8) +
    facet_grid(pscnq_processing_sector~region, scales = "free") +
    ggtitle("Summer Boat Days (Rockfish)") + 
    theme_classic() +
    geom_vline(aes(xintercept="2013"),color="magenta") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
    scale_x_discrete(breaks = every_nth(n = 5))

 
```

```{r FALL new}
#FALL
rockfish_observed %>%  
  ungroup() %>%
  filter(!pscnq_processing_sector=="M") %>%
  select(year,month,region,pscnq_processing_sector,obs_boat_days) %>%   
  filter(month %in% c(8,9,10)) %>%
  group_by(year,region,pscnq_processing_sector) %>%
  summarise(obs_boat_days=sum(obs_boat_days))%>%
  ungroup() %>%
  merge(temp, all = TRUE) %>%
  mutate(obs_boat_days= replace_na(obs_boat_days,0)) %>%
   ggplot() +
    geom_bar(aes(x=year,y=obs_boat_days),stat="identity",alpha = 0.8) +
    facet_grid(pscnq_processing_sector~region, scales = "free") +
    ggtitle("Fall Boat Days (Rockfish)") + 
    theme_classic() +
    geom_vline(aes(xintercept="2013"),color="magenta") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
    scale_x_discrete(breaks = every_nth(n = 5))

```

```{r WINTER new}
 #WINTER
rockfish_observed %>%  
  ungroup() %>%
  filter(!pscnq_processing_sector=="M") %>%
  select(year,month,region,pscnq_processing_sector,obs_boat_days) %>% 
  filter(month %in% c(1,2,3,11,12)) %>%
  mutate(season.temp = case_when(month %in% c(11,12) ~ "winter.1",
                       month %in% c(1:3) ~ "winter.2",
                       TRUE ~ "NA")) %>%
  group_by(year, season.temp,region,pscnq_processing_sector) %>%
  summarise(obs_boat_days=sum(obs_boat_days)) %>%
  ungroup() %>%
  mutate(year=as.numeric(year), year.new = case_when(season.temp == "winter.2" ~ year -1,
                              TRUE ~ year)) %>%
  group_by(year.new, region, pscnq_processing_sector) %>%
  summarise(obs_boat_days=sum(obs_boat_days)) %>%
  dplyr::rename(year=year.new) %>%
  merge(temp) %>%
  mutate(obs_boat_days= replace_na(obs_boat_days,0)) %>%
  ggplot() +
    geom_bar(aes(x=year,y=obs_boat_days), stat="identity",alpha = 0.8) +
    facet_grid(pscnq_processing_sector~region, scales = "free") +
    ggtitle("Winter Boat Days ( Rockfish)") + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7)) +
  geom_vline(aes(xintercept=2013),color="magenta")

 
```

\n Does effort generally line up with recoveries? [Using Rockfish recovery data from JW and AFSC] Shoreside looks good, what is the deal with no recoveries for CP?  This is better for trip target code than management code.... 
```{r CWT Check, echo=FALSE}
#load RMIS data 
rockfish <- read_csv("data/AK_CWT_Rockfish/Rockfish CWT.csv") %>%
  dplyr::mutate(Long=-1*Long, tag_code= str_pad(tag_code, pad = "0", width = 6, side = c("left"))) %>%
  tidyr::separate(recovery_date, into =c("rec_year", "rec_monthrec_day"), sep = 4) %>%
  tidyr::separate(rec_monthrec_day, into =c("rec_month", "rec_day"), sep = 2) %>%
  dplyr::filter(!rec_year %in% c("2018","2019")) %>%
  dplyr::mutate(source="rockfish") %>%
  dplyr::select(-c(fishery, detection_method)) %>%
  ## assign recoveries to our spatial boxes. Some latitudes dont have associated longitudes, but they do have an associated stat area 
  dplyr::mutate(region = case_when(Area == 620 ~ "W.APEN",   
                                              Area == 630 ~ "NW.GOA",
                                              Long < -147 & Long > -154 | Long == -147 ~ "NW.GOA", #"X630",
                                              Long < -154 & Long > -159 | Long == -154 ~ "W.APEN", #"X620",
                                              TRUE~ "FIX" )) %>%  # 5 fish from 2013 from ship Cape Kiwanda that do not have any location info. 
 filter(!Missing_Fins %in% c("None", "none"), !region=="FIX", !rec_year<2013) %>%  #filter out recoveries where the adipose fin wasn't clipped, also filter out recoveries with no lcoatino info, there are only 4.   
 group_by(region, rec_year) %>%
 count(rec_month) %>%
 unite("year.month",c("rec_year","rec_month"), sep = ".")  %>%
 rename(recoveries=n)
  
rockfish_observed %>%  
  ungroup() %>%
  filter(!year<2010 
         #, pscnq_processing_sector=="S"
        ) %>%
  select(year,month,region,obs_boat_days) %>%   
  mutate(month = str_pad(month, "left", pad=0, width = 2) ) %>%
  unite("year.month",c("year","month"), sep = ".") %>% 
  full_join(rockfish, by= c("year.month","region")) %>%
  gather(3:4, key = "category", value = "number") %>%
  mutate(number= replace_na(number,0), category=factor(category, levels=c("recoveries", "obs_boat_days"))) %>%
  filter(!is.na(region), !region %in% c("NE.GOA NW.GOA W.APEN E.APEN BER", "NSEAK")) %>%
    ggplot() +
      geom_bar(aes(x=year.month,y=number, fill = category),position="stack", stat="identity",alpha = 0.8) +
      facet_wrap(~region, scales="free_y") +
      ggtitle("Compare Observed Data and RMIS Recoveries") +  
      theme_classic() +
      theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
      scale_x_discrete(breaks = every_nth(n = 20)) +
  ggtitle("When I use rockfish target code K")
 
```
 
```{r use rockfish management code}
readRDS(here("data","AK_Effort_Trawl","Gasper_data","Unique_trips_Observed.RDS")) %>%
  rename_all(tolower) %>% 
  mutate(month=as.numeric(format(haul_date,"%m")),
           region = case_when(reporting_area_code == "610" ~ "E.APEN", 
                            reporting_area_code == "620" ~ "W.APEN",
                            reporting_area_code %in% c("630") ~ "NW.GOA",
                            reporting_area_code %in% c("640", "640 ") ~ "NE.GOA",
                            TRUE ~ "MISSING_LOCATION_INFO")) %>% 
  group_by(year,management_program_code, catcher_boat_adfg,pscnq_processing_sector,trip_target_code, month,akr_gear_code,region, reporting_area_code) %>%
  summarise(haul_days=length(unique(haul_date[!is.na(haul_date)])),
            vlength=ves_cfec_length[1],
            gf_catch=sum(official_total_catch,na.rm=TRUE)) %>%
  filter(management_program_code =="RPP",!reporting_area_code == "650" #only 4 entries with 650 in mid 1990s
         ) %>% #Filter for rockfish 
  ungroup() %>%
  mutate(season = case_when(month %in% c(1,2,3,11,12) ~ "winter",
                                month %in% c(4, 5) ~ "spring",
                                month %in% c(6,7) ~ "summer",
                                month %in% c(8,9,10) ~ "fall",
                                TRUE~"SEASON_NA"),
         year = as.numeric(year)) %>%  
  group_by(year,pscnq_processing_sector,trip_target_code,season, month,region
           #,length_category, #can add this in later if fish ticket data for obs and unobs has v length?
           ) %>%
  summarise(obs_boat_days = sum(haul_days),
             obs_catch_MT=sum(gf_catch)) %>% #THIS IS IN MT--CONVERT TO LBS OR FISH TICKET CONVERT TO MT
ungroup() %>%
  # filter(!year<2010 
  #        #, pscnq_processing_sector=="S"
  #        ) %>%
  select(year,month,region,obs_boat_days) %>%   
  mutate(month = str_pad(month, "left", pad=0, width = 2) ) %>%
  unite("year.month",c("year","month"), sep = ".") %>% 
  full_join(rockfish, by= c("year.month","region")) %>%
  gather(3:4, key = "category", value = "number") %>%
  mutate(number= replace_na(number,0), category=factor(category, levels=c("recoveries", "obs_boat_days"))) %>%
  filter(!is.na(region), !region %in% c("NE.GOA NW.GOA W.APEN E.APEN BER", "NSEAK")) %>%
    ggplot() +
      geom_bar(aes(x=year.month,y=number, fill = category),position="stack", stat="identity",alpha = 0.8) +
      facet_wrap(~region, scales="free_y") +
      ggtitle("Compare Observed Data and RMIS Recoveries") +  
      theme_classic() +
      theme(axis.text.x = element_text(angle = 90, hjust = 1,size=7))  +
      scale_x_discrete(breaks = every_nth(n = 20)) +
      ggtitle("When I use RPP management code")
```
```{r save data}

saveRDS(rockfish_observed, "data/AK_CWT_Rockfish/rockfish_summarized.RDS")

```

