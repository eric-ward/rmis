library(dplyr)
library(ggplot2)

species = "coho"

# Load release data
release = read.csv(paste0("data/",species,"/all_releases.txt"), header=T, stringsAsFactors = FALSE) 
release = select(release, tag_code_or_release_id, run, brood_year, first_release_date,
  release_location_code, stock_location_code, cwt_1st_mark_count, cwt_2nd_mark_count,
  non_cwt_1st_mark_count, non_cwt_2nd_mark_count, release_location_name,
  stock_location_name, release_location_state, release_location_rmis_region, 
  release_location_rmis_basin) %>% 
  rename(tag_code = tag_code_or_release_id)

# Sum up the total releases, drop unneccessary columns
release = mutate(release, 
  total_release = sum(as.numeric(c(cwt_1st_mark_count, cwt_2nd_mark_count,
    non_cwt_1st_mark_count, non_cwt_2nd_mark_count)),na.rm=T)) %>% 
  dplyr::select(-cwt_1st_mark_count, -cwt_2nd_mark_count,
  -non_cwt_1st_mark_count, -non_cwt_2nd_mark_count)

# pull out relase year
release$release_year = substr(release$first_release_date, 1, 4)
release = select(release, -first_release_date)

# recoveries
recover = read.csv(paste0("data/",species,"/recoveries_1973.csv"), stringsAsFactors = FALSE)
for(y in 1974:2018) {
  recover = rbind(recover, read.csv(paste0("data/",species,"/recoveries_",y,".csv"), 
    stringsAsFactors = FALSE))
}
recover = select(recover, tag_code, recovery_id, recovery_date, fishery, gear, 
  recovery_location_code, recovery_location_name, estimated_number)
recover = filter(recover, !is.na(estimated_number)) %>% 
  filter(tag_code != "")

# Join by tag code
dat = left_join(recover, release)

# pull in location data from RMIS
locations = read.csv("data/locations.txt", stringsAsFactors = FALSE)
locations = locations[,c("location_code","rmis_latitude","rmis_longitude", "description")]
locations = rename(locations, recovery_location_code = location_code,
  recovery_description = description, latitude=rmis_latitude, longitude = rmis_longitude)
dat = left_join(dat, locations)

# summarize recoveries by origin
g = group_by(dat, year, release_location_rmis_basin) %>% 
  summarize(summing = sum(estimated_number)) %>% 
  group_by(release_location_rmis_basin) %>%
  summarize(mean_n = mean(summing, na.rm=T)) %>% 
  arrange(-mean_n)

# location codes: 2(BC), 3 (WA), 5 (OR), 6 (CA), etc.
dat = mutate(dat, recovery_state = substr(recovery_location_code, 1,2)) %>%
  mutate(recovery_year = substr(recovery_date, 1,4),
    recovery_month = substr(recovery_date, 5,6))